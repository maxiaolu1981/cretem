digraph pc_flow {
  rankdir=TB;
  graph [fontname="Arial"];
  node [shape=box, style=rounded, fontname="Arial", color="#2B6CB0", fillcolor="#F7FAFC", style="filled"];
  edge [color="#2B6CB0"];

  handler [label="HTTP Handler\n(validate/auth)", fillcolor="#E6F2FF"];
  limiter [label="WriteRateLimiter\n(local/redis)", fillcolor="#FFECEB", color="#C53030"];
  producer [label="Producer\n(in-flight semaphore)", fillcolor="#E6FFF2", color="#2F855A"];
  kafka [label="Kafka Topic\n(UserCreate/UserDelete)", shape=cylinder, fillcolor="#FFF7E6", color="#B7791F"];
  fetcher [label="Fetcher\n(single loop)"];
  worker_pool [label="Worker Pool\n(N workers)", fillcolor="#E6F2FF"];
  batch [label="Batcher\n(MaxDBBatchSize / timeout)"];
  db [label="DB (GORM)", shape=cylinder, fillcolor="#F0E6FF"];

  handler -> limiter -> producer -> kafka;
  kafka -> fetcher -> worker_pool -> batch -> db;
  worker_pool -> fetcher [style=dashed, label="commit offset"];

  // failure paths
  producer -> retry [label="retry topic", color="#B7791F", style=dashed];
  producer -> dead [label="dead-letter", color="#C53030", style=dotted];
}

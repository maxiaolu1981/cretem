@startuml
title Consumer fetcher -> worker -> batch -> DB -> commit (cdmp-mini)
actor Kafka
participant "Fetcher (StartConsuming)" as Fetcher
participant "Job Channel (jobs)" as Jobs
participant "Worker Pool" as Worker
participant "Batch Goroutine (batchCh)" as Batch
participant "DB (GORM)" as DB
participant "Consumer.commitWithRetry" as Commit

Kafka -> Fetcher: FetchMessage()
Fetcher -> Jobs: create job{msg, done}
note right of Fetcher: Round-robin to workers
Jobs -> Worker: worker picks job
Worker -> Worker: processMessageWithRetry(msg)
alt OperationCreate or OperationDelete
    Worker -> Batch: send batchItem (op,msg) if batch channel available
    Batch -> Batch: accumulate messages until MaxDBBatchSize or BatchTimeout
    Batch -> DB: batchCreateToDB(batch) / batchDeleteFromDB(batch)
    DB --> Batch: success / error
    Batch -> Worker: (batch ack) optional
else Other operations (update)
    Worker -> DB: updateUserInDB / createUserInDB / deleteUserFromDB
    DB --> Worker: success / error
end
Worker -> Jobs: send result on job.done
Jobs -> Fetcher: fetcher receives job.done
Fetcher -> Commit: commitWithRetry(msg)
Commit -> Kafka: CommitMessages(msg)
alt commit success
    Commit --> Fetcher: success
else commit fail
    Commit -> Commit: retry logic with backoff
    Commit --> Fetcher: final result
end

note right
Key points:
- Single fetcher and worker pool decouples network IO from processing CPU/DB.
- Batch goroutine reduces DB transactions by grouping create/delete.
- commitWithRetry ensures offsets are not lost on transient failures.
- Consumer starts a lag monitor to set lagProtected flag when lag high.
end note

note left of Worker
Batching details:
- Batch items grouped by operation (OperationCreate / OperationDelete)
- MaxDBBatchSize configured in KafkaOptions.MaxDBBatchSize
- BatchTimeout controls max wait before flush
DB write functions: batchCreateToDB(batch), batchDeleteFromDB(batch)
end note

note left of Fetcher
Kafka message headers expected (examples):
- HeaderOperation: "CREATE" | "UPDATE" | "DELETE"
- HeaderRetryCount: "0"
- HeaderOriginalTimestamp: RFC3339
Topic names: UserCreateTopic, UserUpdateTopic, UserDeleteTopic, UserRetryTopic, UserDeadLetterTopic
end note
@enduml

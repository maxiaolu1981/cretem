digraph db_flow {
  rankdir=TB;
  node [shape=record, fontname="Arial"];

  subgraph cluster_db {
    label="Database / Persistence";
    style=rounded;
    db [label="DB\n(事务/索引/锁)", shape=cylinder, fillcolor="#f0e6ff", style=filled];
    tx [label="Transactional Writes\n(commit/rollback)", shape=box];
    idx [label="Indexes\n(read/write cost)", shape=note];
    slowq [label="Slow Queries / Locks", shape=diamond, color="#aa0000"];
  }

  app [label="Consumer Batch Writer", shape=box, fillcolor="#e6f2ff", style=filled];
  cache [label="Cache (optional)\ninvalidate/write-through", shape=component];

  app -> tx -> db;
  tx -> idx [style=dashed];
  tx -> slowq [style=dotted, color="#aa0000"];
  app -> cache [label="update/invalidate", style=dashed];

  // notes
  note1 [label="Best practices:\n- Use batched transactions\n- Monitor 95/99 latency\n- Keep indexes minimal for writes", shape=note, fontsize=10];
  db -> note1 [style=dashed, arrowhead=none];
}

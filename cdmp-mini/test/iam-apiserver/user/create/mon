#!/bin/bash

# MySQLåŠ¨æ€ç›‘æ§è„šæœ¬
# é…ç½®å‚æ•°
HOST="127.0.0.1"
PORT="3306"
USERNAME="root"
PASSWORD="iam59!z$"
DATABASE="iam"
INTERVAL=5  # ç›‘æ§é—´éš”ï¼ˆç§’ï¼‰
LOG_FILE="/tmp/mysql_monitor.log"

# é¢œè‰²å®šä¹‰
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

# æ‰§è¡ŒMySQLæŸ¥è¯¢çš„å‡½æ•°
mysql_query() {
    mysql -h $HOST -P $PORT -u $USERNAME -p"$PASSWORD" -D $DATABASE -s -N -e "$1" 2>/dev/null
}

# æ£€æŸ¥MySQLè¿æ¥æ˜¯å¦æ­£å¸¸
check_mysql_connection() {
    if mysql_query "SELECT 1" >/dev/null 2>&1; then
        return 0
    else
        return 1
    fi
}

# æ˜¾ç¤ºå¸¦é¢œè‰²çš„çŠ¶æ€ä¿¡æ¯
show_status() {
    local metric=$1
    local value=$2
    local threshold=$3
    local good_threshold=$4
    
    if [ -z "$value" ]; then
        echo -e "${RED}N/A${NC}"
    elif [ $(echo "$value > $threshold" | bc -l 2>/dev/null) -eq 1 ]; then
        echo -e "${RED}$value${NC} âš ï¸"
    elif [ -n "$good_threshold" ] && [ $(echo "$value < $good_threshold" | bc -l 2>/dev/null) -eq 1 ]; then
        echo -e "${GREEN}$value${NC} âœ…"
    else
        echo -e "${YELLOW}$value${NC}"
    fi
}

# æ¸…ç†å±å¹•å¹¶æ˜¾ç¤ºç›‘æ§ä¿¡æ¯
display_monitor() {
    clear
    echo -e "${BLUE}=== MySQLåŠ¨æ€ç›‘æ§ - åˆ·æ–°é—´éš”: ${INTERVAL}s - $(date) ===${NC}"
    echo
    
    # æ£€æŸ¥MySQLè¿æ¥
    if ! check_mysql_connection; then
        echo -e "${RED}âŒ MySQLè¿æ¥å¤±è´¥ï¼è¯·æ£€æŸ¥æœåŠ¡çŠ¶æ€å’Œè¿æ¥å‚æ•°${NC}"
        echo
        return 1
    fi
    
    # è·å–ç›‘æ§æ•°æ®
    threads_connected=$(mysql_query "SHOW STATUS LIKE 'Threads_connected'" | awk '{print $2}')
    threads_running=$(mysql_query "SHOW STATUS LIKE 'Threads_running'" | awk '{print $2}')
    slow_queries=$(mysql_query "SHOW STATUS LIKE 'Slow_queries'" | awk '{print $2}')
    questions=$(mysql_query "SHOW STATUS LIKE 'Questions'" | awk '{print $2}')
    uptime=$(mysql_query "SHOW STATUS LIKE 'Uptime'" | awk '{print $2}')
    
    # InnoDBçŠ¶æ€
    innodb_row_lock_waits=$(mysql_query "SHOW STATUS LIKE 'Innodb_row_lock_waits'" | awk '{print $2}')
    innodb_row_lock_time_avg=$(mysql_query "SHOW STATUS LIKE 'Innodb_row_lock_time_avg'" | awk '{print $2}')
    
    # ç¼“å†²æ± å‘½ä¸­ç‡
    read_requests=$(mysql_query "SHOW STATUS LIKE 'Innodb_buffer_pool_read_requests'" | awk '{print $2}')
    reads=$(mysql_query "SHOW STATUS LIKE 'Innodb_buffer_pool_reads'" | awk '{print $2}')
    if [ $read_requests -gt 0 ]; then
        hit_ratio=$(echo "scale=2; (1 - $reads / $read_requests) * 100" | bc)
    else
        hit_ratio=100
    fi
    
    # è¡¨é”æƒ…å†µ
    table_locks_waited=$(mysql_query "SHOW STATUS LIKE 'Table_locks_waited'" | awk '{print $2}')
    table_locks_immediate=$(mysql_query "SHOW STATUS LIKE 'Table_locks_immediate'" | awk '{print $2}')
    if [ $((table_locks_waited + table_locks_immediate)) -gt 0 ]; then
        lock_wait_ratio=$(echo "scale=2; $table_locks_waited * 100 / ($table_locks_waited + $table_locks_immediate)" | bc)
    else
        lock_wait_ratio=0
    fi
    
    # æ˜¾ç¤ºåŸºæœ¬ä¿¡æ¯
    echo -e "${BLUE}ğŸ“Š åŸºæœ¬çŠ¶æ€:${NC}"
    echo -e "è¿è¡Œæ—¶é—´: $(show_status uptime $uptime 0) ç§’"
    echo -e "æ€»æŸ¥è¯¢æ•°: $(show_status questions $questions 0)"
    echo -e "è¿æ¥æ•°: $(show_status threads_connected $threads_connected 80 50)"
    echo -e "æ´»è·ƒçº¿ç¨‹: $(show_status threads_running $threads_running 10 5)"
    echo -e "æ…¢æŸ¥è¯¢: $(show_status slow_queries $slow_queries 1 0)"
    echo
    
    # æ˜¾ç¤ºæ€§èƒ½æŒ‡æ ‡
    echo -e "${BLUE}âš¡ æ€§èƒ½æŒ‡æ ‡:${NC}"
    echo -e "ç¼“å†²æ± å‘½ä¸­ç‡: $(show_status hit_ratio $hit_ratio 95 98)%"
    echo -e "è¡Œé”ç­‰å¾…: $(show_status innodb_row_lock_waits $innodb_row_lock_waits 10 5)"
    echo -e "å¹³å‡é”ç­‰å¾…æ—¶é—´: $(show_status innodb_row_lock_time_avg $innodb_row_lock_time_avg 100 50)ms"
    echo -e "è¡¨é”ç­‰å¾…æ¯”ç‡: $(show_status lock_wait_ratio $lock_wait_ratio 1 0.5)%"
    echo
    
    # æ˜¾ç¤ºå½“å‰è¿›ç¨‹
    echo -e "${BLUE}ğŸ” å½“å‰æ´»åŠ¨è¿›ç¨‹:${NC}"
    long_running=$(mysql_query "SELECT ID, USER, TIME, DB, COMMAND, LEFT(INFO, 50) as QUERY FROM INFORMATION_SCHEMA.PROCESSLIST WHERE TIME > 2 AND COMMAND != 'Sleep' AND INFO IS NOT NULL ORDER BY TIME DESC LIMIT 5")
    if [ -n "$long_running" ]; then
        echo "$long_running" | while read line; do
            echo -e "  ${YELLOW}$line${NC}"
        done
    else
        echo -e "  ${GREEN}æ²¡æœ‰é•¿æ—¶é—´è¿è¡Œçš„è¿›ç¨‹${NC}"
    fi
    
    # æ˜¾ç¤ºç³»ç»Ÿè´Ÿè½½
    echo
    echo -e "${BLUE}ğŸ“ˆ ç³»ç»Ÿè´Ÿè½½:${NC}"
    loadavg=$(cat /proc/loadavg | cut -d' ' -f1-3)
    echo -e "CPUè´Ÿè½½: $loadavg"
    
    # è®°å½•åˆ°æ—¥å¿—æ–‡ä»¶
    echo "$(date): Conn=$threads_connected, Running=$threads_running, Slow=$slow_queries, HitRatio=$hit_ratio%" >> "$LOG_FILE"
    
    return 0
}

# æ˜¾ç¤ºä½¿ç”¨è¯´æ˜
show_usage() {
    echo "ä½¿ç”¨æ–¹æ³•: $0 [é€‰é¡¹]"
    echo "é€‰é¡¹:"
    echo "  -i <ç§’æ•°>   è®¾ç½®ç›‘æ§é—´éš”ï¼ˆé»˜è®¤: 5ç§’ï¼‰"
    echo "  -h          æ˜¾ç¤ºå¸®åŠ©ä¿¡æ¯"
    echo "  -l          æ˜¾ç¤ºæ—¥å¿—æ–‡ä»¶"
    echo "  -s          å•æ¬¡è¿è¡Œæ¨¡å¼ï¼ˆä¸æŒç»­ç›‘æ§ï¼‰"
}

# ä¸»å‡½æ•°
main() {
    local single_run=false
    
    # è§£æå‚æ•°
    while getopts "i:hls" opt; do
        case $opt in
            i) INTERVAL=$OPTARG ;;
            h) show_usage; exit 0 ;;
            l) tail -f "$LOG_FILE"; exit 0 ;;
            s) single_run=true ;;
            *) show_usage; exit 1 ;;
        esac
    done
    
    # åˆ›å»ºæ—¥å¿—æ–‡ä»¶
    touch "$LOG_FILE"
    echo "MySQLç›‘æ§å¼€å§‹äº: $(date)" >> "$LOG_FILE"
    
    # ç›‘æ§å¾ªç¯
    while true; do
        display_monitor
        
        if $single_run; then
            break
        fi
        
        # æ˜¾ç¤ºå€’è®¡æ—¶
        for i in $(seq $INTERVAL -1 1); do
            echo -ne "\r${BLUE}ä¸‹æ¬¡åˆ·æ–°: ${i}s (æŒ‰ Ctrl+C é€€å‡º)${NC}"
            sleep 1
        done
        echo -ne "\r"
    done
}

# æ•è·Ctrl+Cä¿¡å·
trap 'echo -e "\n${GREEN}ç›‘æ§å·²åœæ­¢${NC}"; echo "MySQLç›‘æ§ç»“æŸäº: $(date)" >> "$LOG_FILE"; exit 0' INT

# è¿è¡Œä¸»å‡½æ•°
main "$@"